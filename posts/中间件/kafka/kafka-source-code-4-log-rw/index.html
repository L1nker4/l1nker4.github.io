<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.145.0">

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="" />
  <meta property="og:url" content="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka/kafka-source-code-4-log-rw/" />
  <link rel="canonical" href="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka/kafka-source-code-4-log-rw/" /><link rel="apple-touch-icon" href="/favicon.png" />
  <link rel="icon" href="/favicon.png" />
  <link rel="shortcut" href="/favicon.png" /><link rel="alternate" type="application/atom+xml" href="http://localhost:1313/index.xml" title="L1nker4&#39;s Blog | 格木观云">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "http:\/\/localhost:1313\/"
      },
      "articleSection" : "posts",
      "name" : "Kafka源码分析(四) - 日志读写流程",
      "headline" : "Kafka源码分析(四) - 日志读写流程",
      "description" : "Intro 上文介绍了Kafka日志加载的基本流程，本文主要分析Kafka日志的读写流程。\n日志写入的场景主要有以下几种：\n生产者向Leader replica写入消息（包含事务消息） Follow replica拉取消息并写入 消费者组写入组信息 日志写入 从KafkaApis入口类中可以看到produce的处理动作：\ncase ApiKeys.PRODUCE =\u0026gt; handleProduceRequest(request, requestLocal) 这里重点关注日志的写入逻辑，handleProduceRequest()中会调用replicaManager执行append：\n\/\/ call the replica manager to append messages to the replicas replicaManager.handleProduceAppend( timeout = produceRequest.timeout.toLong, requiredAcks = produceRequest.acks, internalTopicsAllowed = internalTopicsAllowed, transactionalId = produceRequest.transactionalId, entriesPerPartition = authorizedRequestInfo, responseCallback = sendResponseCallback, recordValidationStatsCallback = processingStatsCallback, requestLocal = requestLocal, transactionSupportedOperation = transactionSupportedOperation) appendRecords 在ReplicaManager中会调用appendRecords()将其追加到消息对应partition的leader replica中，并且等待leader将其同步到其他replica中。\n\/** * Handles the produce request by starting any transactional verification before appending. * * @param timeout maximum time we will wait to append before returning * @param requiredAcks number of replicas who must acknowledge the append before sending the response * @param internalTopicsAllowed boolean indicating whether internal topics can be appended to * @param transactionalId the transactional ID for the produce request or null if there is none. * @param entriesPerPartition the records per partition to be appended * @param responseCallback callback for sending the response * @param recordValidationStatsCallback callback for updating stats on record conversions * @param requestLocal container for the stateful instances scoped to this request -- this must correspond to the * thread calling this method * @param actionQueue the action queue to use. ReplicaManager#defaultActionQueue is used by default. * @param transactionSupportedOperation determines the supported Operation based on the client\u0026#39;s Request api version * * The responseCallback is wrapped so that it is scheduled on a request handler thread. There, it should be called with * that request handler thread\u0026#39;s thread local and not the one supplied to this method. *\/ def handleProduceAppend(timeout: Long, requiredAcks: Short, internalTopicsAllowed: Boolean, transactionalId: String, entriesPerPartition: Map[TopicPartition, MemoryRecords], responseCallback: Map[TopicPartition, PartitionResponse] =\u0026gt; Unit, recordValidationStatsCallback: Map[TopicPartition, RecordValidationStats] =\u0026gt; Unit = _ =\u0026gt; (), requestLocal: RequestLocal = RequestLocal.NoCaching, actionQueue: ActionQueue = this.defaultActionQueue, transactionSupportedOperation: TransactionSupportedOperation): Unit = { appendRecords( timeout = timeout, requiredAcks = requiredAcks, internalTopicsAllowed = internalTopicsAllowed, origin = AppendOrigin.CLIENT, entriesPerPartition = entriesWithoutErrorsPerPartition, responseCallback = newResponseCallback, recordValidationStatsCallback = recordValidationStatsCallback, requestLocal = newRequestLocal, actionQueue = actionQueue, verificationGuards = verificationGuards ) } 传入的参数较多，重要参数的含义如下：\n",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "2025",
      "datePublished": "2025-02-10 12:51:12 \u002b0800 CST",
      "dateModified" : "2025-02-10 12:51:12 \u002b0800 CST",
      "url" : "http:\/\/localhost:1313\/posts\/%E4%B8%AD%E9%97%B4%E4%BB%B6\/kafka\/kafka-source-code-4-log-rw\/",
      "keywords" : [  ]
  }
</script>
<title>Kafka源码分析(四) - 日志读写流程</title>
  <meta property="og:title" content="Kafka源码分析(四) - 日志读写流程" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="Intro 上文介绍了Kafka日志加载的基本流程，本文主要分析Kafka日志的读写流程。
日志写入的场景主要有以下几种：
生产者向Leader replica写入消息（包含事务消息） Follow replica拉取消息并写入 消费者组写入组信息 日志写入 从KafkaApis入口类中可以看到produce的处理动作：
case ApiKeys.PRODUCE =&gt; handleProduceRequest(request, requestLocal) 这里重点关注日志的写入逻辑，handleProduceRequest()中会调用replicaManager执行append：
// call the replica manager to append messages to the replicas replicaManager.handleProduceAppend( timeout = produceRequest.timeout.toLong, requiredAcks = produceRequest.acks, internalTopicsAllowed = internalTopicsAllowed, transactionalId = produceRequest.transactionalId, entriesPerPartition = authorizedRequestInfo, responseCallback = sendResponseCallback, recordValidationStatsCallback = processingStatsCallback, requestLocal = requestLocal, transactionSupportedOperation = transactionSupportedOperation) appendRecords 在ReplicaManager中会调用appendRecords()将其追加到消息对应partition的leader replica中，并且等待leader将其同步到其他replica中。
/** * Handles the produce request by starting any transactional verification before appending. * * @param timeout maximum time we will wait to append before returning * @param requiredAcks number of replicas who must acknowledge the append before sending the response * @param internalTopicsAllowed boolean indicating whether internal topics can be appended to * @param transactionalId the transactional ID for the produce request or null if there is none. * @param entriesPerPartition the records per partition to be appended * @param responseCallback callback for sending the response * @param recordValidationStatsCallback callback for updating stats on record conversions * @param requestLocal container for the stateful instances scoped to this request -- this must correspond to the * thread calling this method * @param actionQueue the action queue to use. ReplicaManager#defaultActionQueue is used by default. * @param transactionSupportedOperation determines the supported Operation based on the client&#39;s Request api version * * The responseCallback is wrapped so that it is scheduled on a request handler thread. There, it should be called with * that request handler thread&#39;s thread local and not the one supplied to this method. */ def handleProduceAppend(timeout: Long, requiredAcks: Short, internalTopicsAllowed: Boolean, transactionalId: String, entriesPerPartition: Map[TopicPartition, MemoryRecords], responseCallback: Map[TopicPartition, PartitionResponse] =&gt; Unit, recordValidationStatsCallback: Map[TopicPartition, RecordValidationStats] =&gt; Unit = _ =&gt; (), requestLocal: RequestLocal = RequestLocal.NoCaching, actionQueue: ActionQueue = this.defaultActionQueue, transactionSupportedOperation: TransactionSupportedOperation): Unit = { appendRecords( timeout = timeout, requiredAcks = requiredAcks, internalTopicsAllowed = internalTopicsAllowed, origin = AppendOrigin.CLIENT, entriesPerPartition = entriesWithoutErrorsPerPartition, responseCallback = newResponseCallback, recordValidationStatsCallback = recordValidationStatsCallback, requestLocal = newRequestLocal, actionQueue = actionQueue, verificationGuards = verificationGuards ) } 传入的参数较多，重要参数的含义如下：
" />
  <meta name="description" content="Intro 上文介绍了Kafka日志加载的基本流程，本文主要分析Kafka日志的读写流程。
日志写入的场景主要有以下几种：
生产者向Leader replica写入消息（包含事务消息） Follow replica拉取消息并写入 消费者组写入组信息 日志写入 从KafkaApis入口类中可以看到produce的处理动作：
case ApiKeys.PRODUCE =&gt; handleProduceRequest(request, requestLocal) 这里重点关注日志的写入逻辑，handleProduceRequest()中会调用replicaManager执行append：
// call the replica manager to append messages to the replicas replicaManager.handleProduceAppend( timeout = produceRequest.timeout.toLong, requiredAcks = produceRequest.acks, internalTopicsAllowed = internalTopicsAllowed, transactionalId = produceRequest.transactionalId, entriesPerPartition = authorizedRequestInfo, responseCallback = sendResponseCallback, recordValidationStatsCallback = processingStatsCallback, requestLocal = requestLocal, transactionSupportedOperation = transactionSupportedOperation) appendRecords 在ReplicaManager中会调用appendRecords()将其追加到消息对应partition的leader replica中，并且等待leader将其同步到其他replica中。
/** * Handles the produce request by starting any transactional verification before appending. * * @param timeout maximum time we will wait to append before returning * @param requiredAcks number of replicas who must acknowledge the append before sending the response * @param internalTopicsAllowed boolean indicating whether internal topics can be appended to * @param transactionalId the transactional ID for the produce request or null if there is none. * @param entriesPerPartition the records per partition to be appended * @param responseCallback callback for sending the response * @param recordValidationStatsCallback callback for updating stats on record conversions * @param requestLocal container for the stateful instances scoped to this request -- this must correspond to the * thread calling this method * @param actionQueue the action queue to use. ReplicaManager#defaultActionQueue is used by default. * @param transactionSupportedOperation determines the supported Operation based on the client&#39;s Request api version * * The responseCallback is wrapped so that it is scheduled on a request handler thread. There, it should be called with * that request handler thread&#39;s thread local and not the one supplied to this method. */ def handleProduceAppend(timeout: Long, requiredAcks: Short, internalTopicsAllowed: Boolean, transactionalId: String, entriesPerPartition: Map[TopicPartition, MemoryRecords], responseCallback: Map[TopicPartition, PartitionResponse] =&gt; Unit, recordValidationStatsCallback: Map[TopicPartition, RecordValidationStats] =&gt; Unit = _ =&gt; (), requestLocal: RequestLocal = RequestLocal.NoCaching, actionQueue: ActionQueue = this.defaultActionQueue, transactionSupportedOperation: TransactionSupportedOperation): Unit = { appendRecords( timeout = timeout, requiredAcks = requiredAcks, internalTopicsAllowed = internalTopicsAllowed, origin = AppendOrigin.CLIENT, entriesPerPartition = entriesWithoutErrorsPerPartition, responseCallback = newResponseCallback, recordValidationStatsCallback = recordValidationStatsCallback, requestLocal = newRequestLocal, actionQueue = actionQueue, verificationGuards = verificationGuards ) } 传入的参数较多，重要参数的含义如下：
" />
  <meta property="og:locale" content="en-us" /><meta property="og:image" content="/favicon.png" />
  

  
    <style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:1000px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 1em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:75%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:75%;background-color:inherit;border:0;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:1.6}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}.post-content .post-gallery img{width:100%}}@media screen and (max-width:48em){.posts-category{display:none}}table,th,td{border-collapse:collapse;border-style:solid}</style>
  
  
    <style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style>
  

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="L1nker4&#39;s Blog | 格木观云">
  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel="stylesheet">
  
  

  
  
</head>


<body>
  <article class="post " id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="header-title">
    <a href="/"
      >L1nker4&#39;s Blog</a
    >
  </div>
  <div class="header-subtitle">提升认知，解构世界，行有不得，反求诸己</div>
</header>
<div class="row end-md header-items">
  
  <div class="header-item">
    <a href="/links" target="_blank">Links</a>
  </div>
  
  <div class="header-item">
    <a href="/about" target="_blank">About</a>
  </div>
  
  <div class="header-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
</div>
<div class="row">
   
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">Kafka源码分析(四) - 日志读写流程</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2025-02-10 12:51:12 CST">
                
                  2025-02-10
                
              </time>
              
            </div>
            <div class="col-xs-6">
              
            </div>
          </div>
          
        </header>

        <div class="row">
          <div class="col-xs-12 col-md-9">
            <div class="post-content markdown-body">
              
              <h1 id="intro">Intro</h1>
<p>上文介绍了Kafka日志加载的基本流程，本文主要分析Kafka日志的读写流程。</p>
<p>日志写入的场景主要有以下几种：</p>
<ol>
<li>生产者向Leader replica写入消息（包含事务消息）</li>
<li>Follow replica拉取消息并写入</li>
<li>消费者组写入组信息</li>
</ol>
<h1 id="日志写入">日志写入</h1>
<p>从KafkaApis入口类中可以看到produce的处理动作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ApiKeys</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PRODUCE</span> <span style="color:#66d9ef">=&gt;</span> handleProduceRequest<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> requestLocal<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>这里重点关注日志的写入逻辑，handleProduceRequest()中会调用replicaManager执行append：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">// call the replica manager to append messages to the replicas  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>replicaManager<span style="color:#f92672">.</span>handleProduceAppend<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>  timeout <span style="color:#66d9ef">=</span> produceRequest<span style="color:#f92672">.</span>timeout<span style="color:#f92672">.</span>toLong<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  requiredAcks <span style="color:#66d9ef">=</span> produceRequest<span style="color:#f92672">.</span>acks<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  internalTopicsAllowed <span style="color:#66d9ef">=</span> internalTopicsAllowed<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  transactionalId <span style="color:#66d9ef">=</span> produceRequest<span style="color:#f92672">.</span>transactionalId<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  entriesPerPartition <span style="color:#66d9ef">=</span> authorizedRequestInfo<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  responseCallback <span style="color:#66d9ef">=</span> sendResponseCallback<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  recordValidationStatsCallback <span style="color:#66d9ef">=</span> processingStatsCallback<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  requestLocal <span style="color:#66d9ef">=</span> requestLocal<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  transactionSupportedOperation <span style="color:#66d9ef">=</span> transactionSupportedOperation<span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="appendrecords">appendRecords</h2>
<p>在ReplicaManager中会调用appendRecords()将其追加到消息对应partition的leader replica中，并且等待leader将其同步到其他replica中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">/**  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Handles the produce request by starting any transactional verification before appending. * * @param timeout                       maximum time we will wait to append before returning  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param requiredAcks                  number of replicas who must acknowledge the append before sending the response  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param internalTopicsAllowed         boolean indicating whether internal topics can be appended to  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param transactionalId               the transactional ID for the produce request or null if there is none.  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param entriesPerPartition           the records per partition to be appended  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param responseCallback              callback for sending the response  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param recordValidationStatsCallback callback for updating stats on record conversions  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param requestLocal                  container for the stateful instances scoped to this request -- this must correspond to the  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *                                      thread calling this method * @param actionQueue                   the action queue to use. ReplicaManager#defaultActionQueue is used by default.  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param transactionSupportedOperation determines the supported Operation based on the client&#39;s Request api version  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * * The responseCallback is wrapped so that it is scheduled on a request handler thread. There, it should be called with * that request handler thread&#39;s thread local and not the one supplied to this method. */</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> handleProduceAppend<span style="color:#f92672">(</span>timeout<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                        requiredAcks<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Short</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                        internalTopicsAllowed<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                        transactionalId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                        entriesPerPartition<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>                        responseCallback<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">PartitionResponse</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Unit</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                        recordValidationStatsCallback<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">RecordValidationStats</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Unit</span> <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">_</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(),</span>  
</span></span><span style="display:flex;"><span>                        requestLocal<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RequestLocal</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RequestLocal</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NoCaching</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                        actionQueue<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActionQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span>defaultActionQueue<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                        transactionSupportedOperation<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">TransactionSupportedOperation</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	appendRecords<span style="color:#f92672">(</span> 
</span></span><span style="display:flex;"><span>	  timeout <span style="color:#66d9ef">=</span> timeout<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  requiredAcks <span style="color:#66d9ef">=</span> requiredAcks<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  internalTopicsAllowed <span style="color:#66d9ef">=</span> internalTopicsAllowed<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  origin <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">AppendOrigin</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  entriesPerPartition <span style="color:#66d9ef">=</span> entriesWithoutErrorsPerPartition<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  responseCallback <span style="color:#66d9ef">=</span> newResponseCallback<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  recordValidationStatsCallback <span style="color:#66d9ef">=</span> recordValidationStatsCallback<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  requestLocal <span style="color:#66d9ef">=</span> newRequestLocal<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  actionQueue <span style="color:#66d9ef">=</span> actionQueue<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>	  verificationGuards <span style="color:#66d9ef">=</span> verificationGuards  
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>传入的参数较多，重要参数的含义如下：</p>
<ul>
<li>timeout：producer端的<code>request.timeout.ms</code>参数</li>
<li>requiredAcks：producer端的<code>acks</code>参数</li>
<li>internalTopicsAllowed：是否允许向内部主题写入消息</li>
<li>origin：写入方来源，共有四类：REPLICATION（来自leader replica同步的数据）、COORDINATOR（coordinator写入的数据）、CLIENT（客户端写入的数据）、RAFT_LEADER（来自raft leader写入的数据）</li>
<li>entriesPerPartition：需要写入的消息分组，结构为：<code>Map[TopicPartition, MemoryRecords]</code></li>
<li>responseCallback：写入成功后的callback</li>
</ul>
<p>在appendRecords()中会调用appendToLocalLog()将消息写入local log。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">/**  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Append messages to leader replicas of the partition, and wait for them to be replicated to other replicas; * the callback function will be triggered either when timeout or the required acks are satisfied; * if the callback function itself is already synchronized on some object then pass this object to avoid deadlock. * * Noted that all pending delayed check operations are stored in a queue. All callers to ReplicaManager.appendRecords() * are expected to call ActionQueue.tryCompleteActions for all affected partitions, without holding any conflicting * locks. * * @param timeout                       maximum time we will wait to append before returning  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param requiredAcks                  number of replicas who must acknowledge the append before sending the response  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param internalTopicsAllowed         boolean indicating whether internal topics can be appended to  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param origin                        source of the append request (ie, client, replication, coordinator)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param entriesPerPartition           the records per partition to be appended  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param responseCallback              callback for sending the response  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param delayedProduceLock            lock for the delayed actions  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param recordValidationStatsCallback callback for updating stats on record conversions  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param requestLocal                  container for the stateful instances scoped to this request -- this must correspond to the  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *                                      thread calling this method * @param actionQueue                   the action queue to use. ReplicaManager#defaultActionQueue is used by default.  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param verificationGuards            the mapping from topic partition to verification guards if transaction verification is used  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> appendRecords<span style="color:#f92672">(</span>timeout<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  requiredAcks<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Short</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  internalTopicsAllowed<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  origin<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">AppendOrigin</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  entriesPerPartition<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>                  responseCallback<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">PartitionResponse</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Unit</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  delayedProduceLock<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Option</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Lock</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">None</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  recordValidationStatsCallback<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">RecordValidationStats</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Unit</span> <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">_</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(),</span>  
</span></span><span style="display:flex;"><span>                  requestLocal<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RequestLocal</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RequestLocal</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NoCaching</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  actionQueue<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActionQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span>defaultActionQueue<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  verificationGuards<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">VerificationGuard</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Map</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.1 检查ack参数是否合法  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isValidRequiredAcks<span style="color:#f92672">(</span>requiredAcks<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    sendInvalidRequiredAcksResponse<span style="color:#f92672">(</span>entriesPerPartition<span style="color:#f92672">,</span> responseCallback<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.2 调用appendToLocalLog写入local log  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> sTime <span style="color:#66d9ef">=</span> time<span style="color:#f92672">.</span>milliseconds  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> localProduceResults <span style="color:#66d9ef">=</span> appendToLocalLog<span style="color:#f92672">(</span>internalTopicsAllowed <span style="color:#66d9ef">=</span> internalTopicsAllowed<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    origin<span style="color:#f92672">,</span> entriesPerPartition<span style="color:#f92672">,</span> requiredAcks<span style="color:#f92672">,</span> requestLocal<span style="color:#f92672">,</span> verificationGuards<span style="color:#f92672">.</span>toMap<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  debug<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Produce to local log in %d ms&#34;</span><span style="color:#f92672">.</span>format<span style="color:#f92672">(</span>time<span style="color:#f92672">.</span>milliseconds <span style="color:#f92672">-</span> sTime<span style="color:#f92672">))</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.3 构建ProducePartitionStatus  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> produceStatus <span style="color:#66d9ef">=</span> buildProducePartitionStatus<span style="color:#f92672">(</span>localProduceResults<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.4 将写入完成的响应结果localProduceResults，加到actionQueue，如果leader high watermark发生变更，会触发一些延迟操作  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  addCompletePurgatoryAction<span style="color:#f92672">(</span>actionQueue<span style="color:#f92672">,</span> localProduceResults<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  recordValidationStatsCallback<span style="color:#f92672">(</span>localProduceResults<span style="color:#f92672">.</span>map <span style="color:#f92672">{</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>k<span style="color:#f92672">,</span> v<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>    k <span style="color:#f92672">-&gt;</span> v<span style="color:#f92672">.</span>info<span style="color:#f92672">.</span>recordValidationStats  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">})</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.5 检查是否需要执行延迟操作  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  maybeAddDelayedProduce<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>    requiredAcks<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    delayedProduceLock<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    timeout<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    entriesPerPartition<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    localProduceResults<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    produceStatus<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    responseCallback  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="appendtolocallog">appendToLocalLog</h2>
<p>该方法中会获取到消息对应的Partition对象，并调用appendRecordsToLeader()完成写入。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> appendToLocalLog<span style="color:#f92672">(</span>internalTopicsAllowed<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                             origin<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">AppendOrigin</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                             entriesPerPartition<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>                             requiredAcks<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Short</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                             requestLocal<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RequestLocal</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                             verificationGuards<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">VerificationGuard</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">LogAppendResult</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  entriesPerPartition<span style="color:#f92672">.</span>map <span style="color:#f92672">{</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">,</span> records<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>    brokerTopicStats<span style="color:#f92672">.</span>topicStats<span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">.</span>topic<span style="color:#f92672">).</span>totalProduceRequestRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>    brokerTopicStats<span style="color:#f92672">.</span>allTopicsStats<span style="color:#f92672">.</span>totalProduceRequestRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// reject appending to internal topics if it is not allowed  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#a6e22e">Topic</span><span style="color:#f92672">.</span>isInternal<span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">.</span>topic<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>internalTopicsAllowed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">,</span> <span style="color:#a6e22e">LogAppendResult</span><span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">LogAppendInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">UNKNOWN_LOG_APPEND_INFO</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">InvalidTopicException</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Cannot append to internal topic </span><span style="color:#e6db74">${</span>topicPartition<span style="color:#f92672">.</span>topic<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)),</span>  
</span></span><span style="display:flex;"><span>        hasCustomErrorMessage <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">))</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//1.1 获取partition对象  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> partition <span style="color:#66d9ef">=</span> getPartitionOrException<span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.2 向该分区对象写入消息集合  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">val</span> info <span style="color:#66d9ef">=</span> partition<span style="color:#f92672">.</span>appendRecordsToLeader<span style="color:#f92672">(</span>records<span style="color:#f92672">,</span> origin<span style="color:#f92672">,</span> requiredAcks<span style="color:#f92672">,</span> requestLocal<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>          verificationGuards<span style="color:#f92672">.</span>getOrElse<span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">,</span> <span style="color:#a6e22e">VerificationGuard</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SENTINEL</span><span style="color:#f92672">))</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> numAppendedMessages <span style="color:#66d9ef">=</span> info<span style="color:#f92672">.</span>numMessages  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.3 返回写入结果  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// update stats for successfully appended bytes and messages as bytesInRate and messageInRate  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        brokerTopicStats<span style="color:#f92672">.</span>topicStats<span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">.</span>topic<span style="color:#f92672">).</span>bytesInRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">(</span>records<span style="color:#f92672">.</span>sizeInBytes<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        brokerTopicStats<span style="color:#f92672">.</span>allTopicsStats<span style="color:#f92672">.</span>bytesInRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">(</span>records<span style="color:#f92672">.</span>sizeInBytes<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        brokerTopicStats<span style="color:#f92672">.</span>topicStats<span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">.</span>topic<span style="color:#f92672">).</span>messagesInRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">(</span>numAppendedMessages<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        brokerTopicStats<span style="color:#f92672">.</span>allTopicsStats<span style="color:#f92672">.</span>messagesInRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">(</span>numAppendedMessages<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> appendRecordsToLeader<span style="color:#f92672">(</span>records<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">,</span> origin<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">AppendOrigin</span><span style="color:#f92672">,</span> requiredAcks<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                          requestLocal<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RequestLocal</span><span style="color:#f92672">,</span> verificationGuard<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">VerificationGuard</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">VerificationGuard</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SENTINEL</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogAppendInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.1 加读锁  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> <span style="color:#f92672">(</span>info<span style="color:#f92672">,</span> leaderHWIncremented<span style="color:#f92672">)</span> <span style="color:#66d9ef">=</span> inReadLock<span style="color:#f92672">(</span>leaderIsrUpdateLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1.2 判断是否为leader副本  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    leaderLogIfLocal <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span>leaderLog<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.3 获取最小ISR  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">val</span> minIsr <span style="color:#66d9ef">=</span> effectiveMinIsr<span style="color:#f92672">(</span>leaderLog<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> inSyncSize <span style="color:#66d9ef">=</span> partitionState<span style="color:#f92672">.</span>isr<span style="color:#f92672">.</span>size  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Avoid writing to leader if there are not enough insync replicas to make it safe  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inSyncSize <span style="color:#f92672">&lt;</span> minIsr <span style="color:#f92672">&amp;&amp;</span> requiredAcks <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">NotEnoughReplicasException</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;The size of the current ISR </span><span style="color:#e6db74">${</span>partitionState<span style="color:#f92672">.</span>isr<span style="color:#e6db74">}</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">s&#34;is insufficient to satisfy the min.isr requirement of </span><span style="color:#e6db74">$minIsr</span><span style="color:#e6db74"> for partition </span><span style="color:#e6db74">$topicPartition</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1.4 调用UnifiedLog的appendAsLeader方法进行写入  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">val</span> info <span style="color:#66d9ef">=</span> leaderLog<span style="color:#f92672">.</span>appendAsLeader<span style="color:#f92672">(</span>records<span style="color:#f92672">,</span> leaderEpoch <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span>leaderEpoch<span style="color:#f92672">,</span> origin<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>          interBrokerProtocolVersion<span style="color:#f92672">,</span> requestLocal<span style="color:#f92672">,</span> verificationGuard<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// we may need to increment high watermark since ISR could be down to 1  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">(</span>info<span style="color:#f92672">,</span> maybeIncrementLeaderHW<span style="color:#f92672">(</span>leaderLog<span style="color:#f92672">))</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">None</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">NotLeaderOrFollowerException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Leader not local for partition %s on broker %d&#34;</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">.</span>format<span style="color:#f92672">(</span>topicPartition<span style="color:#f92672">,</span> localBrokerId<span style="color:#f92672">))</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  info<span style="color:#f92672">.</span>copy<span style="color:#f92672">(</span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>leaderHWIncremented<span style="color:#f92672">)</span> <span style="color:#a6e22e">LeaderHwChange</span><span style="color:#f92672">.</span><span style="color:#a6e22e">INCREASED</span> <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">LeaderHwChange</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SAME</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> appendAsLeader<span style="color:#f92672">(</span>records<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   leaderEpoch<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   origin<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">AppendOrigin</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">AppendOrigin</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   interBrokerProtocolVersion<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MetadataVersion</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">MetadataVersion</span><span style="color:#f92672">.</span>latestProduction<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   requestLocal<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RequestLocal</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RequestLocal</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NoCaching</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   verificationGuard<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">VerificationGuard</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">VerificationGuard</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SENTINEL</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogAppendInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> validateAndAssignOffsets <span style="color:#66d9ef">=</span> origin <span style="color:#f92672">!=</span> <span style="color:#a6e22e">AppendOrigin</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RAFT_LEADER</span>  
</span></span><span style="display:flex;"><span>  append<span style="color:#f92672">(</span>records<span style="color:#f92672">,</span> origin<span style="color:#f92672">,</span> interBrokerProtocolVersion<span style="color:#f92672">,</span> validateAndAssignOffsets<span style="color:#f92672">,</span> leaderEpoch<span style="color:#f92672">,</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span>requestLocal<span style="color:#f92672">),</span> verificationGuard<span style="color:#f92672">,</span> ignoreRecordSize <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>先看下UnifiedLog的append方法参数：</p>
<ul>
<li>records：待插入的消息记录</li>
<li>origin：上文提到的消息插入来源</li>
<li>interBrokerProtocolVersion：broker消息版本</li>
<li>validateAndAssignOffsets：是否需要校验并给消息分配offset</li>
<li>leaderEpoch：leader选举版本</li>
<li>requstLocal：用于存储请求信息的有状态本地容器</li>
<li>ignoreRecordSize：是否忽略校验大小</li>
</ul>
<p>方法内部首先做数据校验，分配offset，再通过LocalLog进行写入。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> append<span style="color:#f92672">(</span>records<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   origin<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">AppendOrigin</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   interBrokerProtocolVersion<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MetadataVersion</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   validateAndAssignOffsets<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   leaderEpoch<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   requestLocal<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Option</span><span style="color:#f92672">[</span><span style="color:#66d9ef">RequestLocal</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>                   verificationGuard<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">VerificationGuard</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                   ignoreRecordSize<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogAppendInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// We want to ensure the partition metadata file is written to the log dir before any log data is written to disk.  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// This will ensure that any log data can be recovered with the correct topic ID in the case of failure.  //1.1 将metadata文件刷入磁盘  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  maybeFlushMetadataFile<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.2 校验消息  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> appendInfo <span style="color:#66d9ef">=</span> analyzeAndValidateRecords<span style="color:#f92672">(</span>records<span style="color:#f92672">,</span> origin<span style="color:#f92672">,</span> ignoreRecordSize<span style="color:#f92672">,</span> <span style="color:#f92672">!</span>validateAndAssignOffsets<span style="color:#f92672">,</span> leaderEpoch<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// return if we have no valid messages or if this is a duplicate of the last appended entry  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>appendInfo<span style="color:#f92672">.</span>validBytes <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> appendInfo  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1.3 清除消息中的不合法字节  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// trim any invalid bytes or partial messages before appending it to the on-disk log  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> validRecords <span style="color:#66d9ef">=</span> trimInvalidBytes<span style="color:#f92672">(</span>records<span style="color:#f92672">,</span> appendInfo<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1.4 设置同步，执行写入  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// they are valid, insert them in the log  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    lock synchronized <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      maybeHandleIOException<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Error while appending records to </span><span style="color:#e6db74">$topicPartition</span><span style="color:#e6db74"> in dir </span><span style="color:#e6db74">${</span>dir<span style="color:#f92672">.</span>getParent<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>        localLog<span style="color:#f92672">.</span>checkIfMemoryMappedBufferClosed<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//1.5 检查是否需要手动分配offset  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validateAndAssignOffsets<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// assign offsets to the message set  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">val</span> offset <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">PrimitiveRef</span><span style="color:#f92672">.</span>ofLong<span style="color:#f92672">(</span>localLog<span style="color:#f92672">.</span>logEndOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          appendInfo<span style="color:#f92672">.</span>setFirstOffset<span style="color:#f92672">(</span>offset<span style="color:#f92672">.</span>value<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">val</span> validateAndOffsetAssignResult <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">val</span> targetCompression <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">BrokerCompressionType</span><span style="color:#f92672">.</span>targetCompression<span style="color:#f92672">(</span>config<span style="color:#f92672">.</span>compression<span style="color:#f92672">,</span> appendInfo<span style="color:#f92672">.</span>sourceCompression<span style="color:#f92672">())</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">val</span> validator <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LogValidator</span><span style="color:#f92672">(</span>validRecords<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              topicPartition<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              time<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              appendInfo<span style="color:#f92672">.</span>sourceCompression<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              targetCompression<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              config<span style="color:#f92672">.</span>compact<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              config<span style="color:#f92672">.</span>recordVersion<span style="color:#f92672">.</span>value<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              config<span style="color:#f92672">.</span>messageTimestampType<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              config<span style="color:#f92672">.</span>messageTimestampBeforeMaxMs<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              config<span style="color:#f92672">.</span>messageTimestampAfterMaxMs<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              leaderEpoch<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              origin<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              interBrokerProtocolVersion  
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            validator<span style="color:#f92672">.</span>validateMessagesAndAssignOffsets<span style="color:#f92672">(</span>offset<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              validatorMetricsRecorder<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              requestLocal<span style="color:#f92672">.</span>getOrElse<span style="color:#f92672">(</span><span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">IllegalArgumentException</span><span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;requestLocal should be defined if assignOffsets is true&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">).</span>bufferSupplier  
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> e<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">IOException</span> <span style="color:#f92672">=&gt;</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">KafkaException</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Error validating messages while appending to log </span><span style="color:#e6db74">$name</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>          validRecords <span style="color:#66d9ef">=</span> validateAndOffsetAssignResult<span style="color:#f92672">.</span>validatedRecords  
</span></span><span style="display:flex;"><span>          appendInfo<span style="color:#f92672">.</span>setMaxTimestamp<span style="color:#f92672">(</span>validateAndOffsetAssignResult<span style="color:#f92672">.</span>maxTimestampMs<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          appendInfo<span style="color:#f92672">.</span>setShallowOffsetOfMaxTimestamp<span style="color:#f92672">(</span>validateAndOffsetAssignResult<span style="color:#f92672">.</span>shallowOffsetOfMaxTimestamp<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          appendInfo<span style="color:#f92672">.</span>setLastOffset<span style="color:#f92672">(</span>offset<span style="color:#f92672">.</span>value <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          appendInfo<span style="color:#f92672">.</span>setRecordValidationStats<span style="color:#f92672">(</span>validateAndOffsetAssignResult<span style="color:#f92672">.</span>recordValidationStats<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>config<span style="color:#f92672">.</span>messageTimestampType <span style="color:#f92672">==</span> <span style="color:#a6e22e">TimestampType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">LOG_APPEND_TIME</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            appendInfo<span style="color:#f92672">.</span>setLogAppendTime<span style="color:#f92672">(</span>validateAndOffsetAssignResult<span style="color:#f92672">.</span>logAppendTimeMs<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// re-validate message sizes if there&#39;s a possibility that they have changed (due to re-compression or message  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#75715e">// format conversion)          if (!ignoreRecordSize &amp;&amp; validateAndOffsetAssignResult.messageSizeMaybeChanged) {  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            validRecords<span style="color:#f92672">.</span>batches<span style="color:#f92672">.</span>forEach <span style="color:#f92672">{</span> batch <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>batch<span style="color:#f92672">.</span>sizeInBytes <span style="color:#f92672">&gt;</span> config<span style="color:#f92672">.</span>maxMessageSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// we record the original message set size instead of the trimmed size  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// to be consistent with pre-compression bytesRejectedRate recording                brokerTopicStats.topicStats(topicPartition.topic).bytesRejectedRate.mark(records.sizeInBytes)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                brokerTopicStats<span style="color:#f92672">.</span>allTopicsStats<span style="color:#f92672">.</span>bytesRejectedRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">(</span>records<span style="color:#f92672">.</span>sizeInBytes<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RecordTooLargeException</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Message batch size is </span><span style="color:#e6db74">${</span>batch<span style="color:#f92672">.</span>sizeInBytes<span style="color:#e6db74">}</span><span style="color:#e6db74"> bytes in append to&#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">s&#34;partition </span><span style="color:#e6db74">$topicPartition</span><span style="color:#e6db74"> which exceeds the maximum configured size of </span><span style="color:#e6db74">${</span>config<span style="color:#f92672">.</span>maxMessageSize<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// 从appendInfo获取offset  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#75715e">// we are taking the offsets we are given          if (appendInfo.firstOrLastOffsetOfFirstBatch &lt; localLog.logEndOffset) {  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// we may still be able to recover if the log is empty  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// one example: fetching from log start offset on the leader which is not batch aligned,            // which may happen as a result of AdminClient#deleteRecords()            val hasFirstOffset = appendInfo.firstOffset != UnifiedLog.UnknownOffset  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">val</span> firstOffset <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasFirstOffset<span style="color:#f92672">)</span> appendInfo<span style="color:#f92672">.</span>firstOffset <span style="color:#66d9ef">else</span> records<span style="color:#f92672">.</span>batches<span style="color:#f92672">.</span>iterator<span style="color:#f92672">().</span>next<span style="color:#f92672">().</span>baseOffset<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">val</span> firstOrLast <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasFirstOffset<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;First offset&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;Last offset of the first batch&#34;</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">UnexpectedAppendOffsetException</span><span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">s&#34;Unexpected offset in append to </span><span style="color:#e6db74">$topicPartition</span><span style="color:#e6db74">. </span><span style="color:#e6db74">$firstOrLast</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>appendInfo<span style="color:#f92672">.</span>firstOrLastOffsetOfFirstBatch<span style="color:#e6db74">}</span><span style="color:#e6db74"> is less than the next offset </span><span style="color:#e6db74">${</span>localLog<span style="color:#f92672">.</span>logEndOffset<span style="color:#e6db74">}</span><span style="color:#e6db74">. &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">s&#34;First 10 offsets in append: </span><span style="color:#e6db74">${</span>records<span style="color:#f92672">.</span>records<span style="color:#f92672">.</span>asScala<span style="color:#f92672">.</span>take<span style="color:#f92672">(</span><span style="color:#ae81ff">10</span><span style="color:#f92672">).</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>offset<span style="color:#f92672">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, last offset in&#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">s&#34; append: </span><span style="color:#e6db74">${</span>appendInfo<span style="color:#f92672">.</span>lastOffset<span style="color:#e6db74">}</span><span style="color:#e6db74">. Log start offset = </span><span style="color:#e6db74">$logStartOffset</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>              firstOffset<span style="color:#f92672">,</span> appendInfo<span style="color:#f92672">.</span>lastOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// update the epoch cache with the epoch stamped onto the message by the leader  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        validRecords<span style="color:#f92672">.</span>batches<span style="color:#f92672">.</span>forEach <span style="color:#f92672">{</span> batch <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>batch<span style="color:#f92672">.</span>magic <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">RecordBatch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MAGIC_VALUE_V2</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>            maybeAssignEpochStartOffset<span style="color:#f92672">(</span>batch<span style="color:#f92672">.</span>partitionLeaderEpoch<span style="color:#f92672">,</span> batch<span style="color:#f92672">.</span>baseOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// In partial upgrade scenarios, we may get a temporary regression to the message format. In  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// order to ensure the safety of leader election, we clear the epoch cache so that we revert            // to truncation by high watermark after the next leader election.            leaderEpochCache.filter(_.nonEmpty).foreach { cache =&gt;  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              warn<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Clearing leader epoch cache after unexpected append with message format v</span><span style="color:#e6db74">${</span>batch<span style="color:#f92672">.</span>magic<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>              cache<span style="color:#f92672">.</span>clearAndFlush<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// check messages set size may be exceed config.segmentSize  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validRecords<span style="color:#f92672">.</span>sizeInBytes <span style="color:#f92672">&gt;</span> config<span style="color:#f92672">.</span>segmentSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RecordBatchTooLargeException</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Message batch size is </span><span style="color:#e6db74">${</span>validRecords<span style="color:#f92672">.</span>sizeInBytes<span style="color:#e6db74">}</span><span style="color:#e6db74"> bytes in append &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">s&#34;to partition </span><span style="color:#e6db74">$topicPartition</span><span style="color:#e6db74">, which exceeds the maximum configured segment size of </span><span style="color:#e6db74">${</span>config<span style="color:#f92672">.</span>segmentSize<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.1 检查LogSegment是否已满，并返回对应的LogSegment  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// maybe roll the log if this segment is full        val segment = maybeRoll(validRecords.sizeInBytes, appendInfo)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> logOffsetMetadata <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LogOffsetMetadata</span><span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>          appendInfo<span style="color:#f92672">.</span>firstOrLastOffsetOfFirstBatch<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>          segment<span style="color:#f92672">.</span>baseOffset<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>          segment<span style="color:#f92672">.</span>size<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.2 检查事务状态  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// now that we have valid records, offsets assigned, and timestamps updated, we need to  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// validate the idempotent/transactional state of the producers and collect some metadata        val (updatedProducers, completedTxns, maybeDuplicate) = analyzeAndValidateProducerState(  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          logOffsetMetadata<span style="color:#f92672">,</span> validRecords<span style="color:#f92672">,</span> origin<span style="color:#f92672">,</span> verificationGuard<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        maybeDuplicate <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Some</span><span style="color:#f92672">(</span>duplicate<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>            appendInfo<span style="color:#f92672">.</span>setFirstOffset<span style="color:#f92672">(</span>duplicate<span style="color:#f92672">.</span>firstOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            appendInfo<span style="color:#f92672">.</span>setLastOffset<span style="color:#f92672">(</span>duplicate<span style="color:#f92672">.</span>lastOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            appendInfo<span style="color:#f92672">.</span>setLogAppendTime<span style="color:#f92672">(</span>duplicate<span style="color:#f92672">.</span>timestamp<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            appendInfo<span style="color:#f92672">.</span>setLogStartOffset<span style="color:#f92672">(</span>logStartOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">None</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Append the records, and increment the local log end offset immediately after the append because a  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// write to the transaction index below may fail and we want to ensure that the offsets            // of future appends still grow monotonically. The resulting transaction index inconsistency            // will be cleaned up after the log directory is recovered. Note that the end offset of the            // ProducerStateManager will not be updated and the last stable offset will not advance            // if the append to the transaction index fails.  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//2.3 调用append()方法执行写入，并更新localLog.logEndOffset和highWatermark  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            localLog<span style="color:#f92672">.</span>append<span style="color:#f92672">(</span>appendInfo<span style="color:#f92672">.</span>lastOffset<span style="color:#f92672">,</span> appendInfo<span style="color:#f92672">.</span>maxTimestamp<span style="color:#f92672">,</span> appendInfo<span style="color:#f92672">.</span>shallowOffsetOfMaxTimestamp<span style="color:#f92672">,</span> validRecords<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            updateHighWatermarkWithLogEndOffset<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// update the producer state  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            updatedProducers<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>foreach<span style="color:#f92672">(</span>producerAppendInfo <span style="color:#66d9ef">=&gt;</span> producerStateManager<span style="color:#f92672">.</span>update<span style="color:#f92672">(</span>producerAppendInfo<span style="color:#f92672">))</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// update the transaction index with the true last stable offset. The last offset visible  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// to consumers using READ_COMMITTED will be limited by this value and the high watermark.            completedTxns.foreach { completedTxn =&gt;  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#66d9ef">val</span> lastStableOffset <span style="color:#66d9ef">=</span> producerStateManager<span style="color:#f92672">.</span>lastStableOffset<span style="color:#f92672">(</span>completedTxn<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>              segment<span style="color:#f92672">.</span>updateTxnIndex<span style="color:#f92672">(</span>completedTxn<span style="color:#f92672">,</span> lastStableOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>              producerStateManager<span style="color:#f92672">.</span>completeTxn<span style="color:#f92672">(</span>completedTxn<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// always update the last producer id map offset so that the snapshot reflects the current offset  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// even if there isn&#39;t any idempotent data being written            producerStateManager.updateMapEndOffset(appendInfo.lastOffset + 1)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// update the first unstable offset (which is used to compute LSO)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            maybeIncrementFirstUnstableOffset<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            trace<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Appended message set with last offset: </span><span style="color:#e6db74">${</span>appendInfo<span style="color:#f92672">.</span>lastOffset<span style="color:#e6db74">}</span><span style="color:#e6db74">, &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">s&#34;first offset: </span><span style="color:#e6db74">${</span>appendInfo<span style="color:#f92672">.</span>firstOffset<span style="color:#e6db74">}</span><span style="color:#e6db74">, &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">s&#34;next offset: </span><span style="color:#e6db74">${</span>localLog<span style="color:#f92672">.</span>logEndOffset<span style="color:#e6db74">}</span><span style="color:#e6db74">, &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">s&#34;and messages: </span><span style="color:#e6db74">$validRecords</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLog<span style="color:#f92672">.</span>unflushedMessages <span style="color:#f92672">&gt;=</span> config<span style="color:#f92672">.</span>flushInterval<span style="color:#f92672">)</span> flush<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>        appendInfo  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">[</span><span style="color:#66d9ef">log</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">def</span> append<span style="color:#f92672">(</span>lastOffset<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span> largestTimestamp<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span> shallowOffsetOfMaxTimestamp<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span> records<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  segments<span style="color:#f92672">.</span>activeSegment<span style="color:#f92672">.</span>append<span style="color:#f92672">(</span>lastOffset<span style="color:#f92672">,</span> largestTimestamp<span style="color:#f92672">,</span> shallowOffsetOfMaxTimestamp<span style="color:#f92672">,</span> records<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  updateLogEndOffset<span style="color:#f92672">(</span>lastOffset <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>LogSegment写入流程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param largestOffset 最大消息位移值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param largestTimestampMs 最大消息时间戳 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param shallowOffsetOfMaxTimestamp 最大时间戳对应的消息位移
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param records 消息体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">long</span> largestOffset,  
</span></span><span style="display:flex;"><span>                   <span style="color:#66d9ef">long</span> largestTimestampMs,  
</span></span><span style="display:flex;"><span>                   <span style="color:#66d9ef">long</span> shallowOffsetOfMaxTimestamp,  
</span></span><span style="display:flex;"><span>                   MemoryRecords records) <span style="color:#66d9ef">throws</span> IOException {  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1. 判断消息是否为空  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (records.<span style="color:#a6e22e">sizeInBytes</span>() <span style="color:#f92672">&gt;</span> 0) {  
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#a6e22e">trace</span>(<span style="color:#e6db74">&#34;Inserting {} bytes at end offset {} at position {} with largest timestamp {} at offset {}&#34;</span>,  
</span></span><span style="display:flex;"><span>            records.<span style="color:#a6e22e">sizeInBytes</span>(), largestOffset, log.<span style="color:#a6e22e">sizeInBytes</span>(), largestTimestampMs, shallowOffsetOfMaxTimestamp);  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> physicalPosition <span style="color:#f92672">=</span> log.<span style="color:#a6e22e">sizeInBytes</span>();  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (physicalPosition <span style="color:#f92672">==</span> 0)  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//1.1 如果日志体为空  </span>
</span></span><span style="display:flex;"><span>            rollingBasedTimestamp <span style="color:#f92672">=</span> OptionalLong.<span style="color:#a6e22e">of</span>(largestTimestampMs);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2. 确保offset合法，规则：0 &lt;= largestOffset - baseOffset &lt;= Integer.MAX_VALUE  </span>
</span></span><span style="display:flex;"><span>        ensureOffsetInRange(largestOffset);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3. 调用FileRecords的append进行写入  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> appendedBytes <span style="color:#f92672">=</span> log.<span style="color:#a6e22e">append</span>(records);  
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#a6e22e">trace</span>(<span style="color:#e6db74">&#34;Appended {} to {} at end offset {}&#34;</span>, appendedBytes, log.<span style="color:#a6e22e">file</span>(), largestOffset);  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4. 更新日志的最大时间戳  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (largestTimestampMs <span style="color:#f92672">&gt;</span> maxTimestampSoFar()) {  
</span></span><span style="display:flex;"><span>            maxTimestampAndOffsetSoFar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TimestampOffset(largestTimestampMs, shallowOffsetOfMaxTimestamp);  
</span></span><span style="display:flex;"><span>        }  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.1 判断是否需要更新索引  </span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (bytesSinceLastIndexEntry <span style="color:#f92672">&gt;</span> indexIntervalBytes) {  
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e">//4.1.1 更新offset index  </span>
</span></span><span style="display:flex;"><span>		    offsetIndex().<span style="color:#a6e22e">append</span>(largestOffset, physicalPosition);  
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e">//4.1.2 更新time index  </span>
</span></span><span style="display:flex;"><span>		    timeIndex().<span style="color:#a6e22e">maybeAppend</span>(maxTimestampSoFar(), shallowOffsetOfMaxTimestampSoFar());  
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e">//4.1.3 重置bytesSinceLastIndexEntry  </span>
</span></span><span style="display:flex;"><span>		    bytesSinceLastIndexEntry <span style="color:#f92672">=</span> 0;  
</span></span><span style="display:flex;"><span>		} 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//4.2 更新bytesSinceLastIndexEntry  </span>
</span></span><span style="display:flex;"><span>        bytesSinceLastIndexEntry <span style="color:#f92672">+=</span> records.<span style="color:#a6e22e">sizeInBytes</span>();  
</span></span><span style="display:flex;"><span>    }  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="maybeadddelayedproduce">maybeAddDelayedProduce</h2>
<p>向远程其他副本发送写入请求需要满足三个条件：</p>
<ol>
<li>acks = -1</li>
<li>写入分区消息非空</li>
<li>本地leader副本的分区消息，至少有一条成功写入</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> maybeAddDelayedProduce<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>  requiredAcks<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Short</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  delayedProduceLock<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Option</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Lock</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>  timeoutMs<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  entriesPerPartition<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">MemoryRecords</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>  initialAppendResults<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">LogAppendResult</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>  initialProduceStatus<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">ProducePartitionStatus</span><span style="color:#f92672">],</span>  
</span></span><span style="display:flex;"><span>  responseCallback<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicPartition</span>, <span style="color:#66d9ef">PartitionResponse</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Unit</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.1 检查是否满足远程写入的要求  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delayedProduceRequestRequired<span style="color:#f92672">(</span>requiredAcks<span style="color:#f92672">,</span> entriesPerPartition<span style="color:#f92672">,</span> initialAppendResults<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create delayed produce operation  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> produceMetadata <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">ProduceMetadata</span><span style="color:#f92672">(</span>requiredAcks<span style="color:#f92672">,</span> initialProduceStatus<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> delayedProduce <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DelayedProduce</span><span style="color:#f92672">(</span>timeoutMs<span style="color:#f92672">,</span> produceMetadata<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> responseCallback<span style="color:#f92672">,</span> delayedProduceLock<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create a list of (topic, partition) pairs to use as keys for this delayed produce operation  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> producerRequestKeys <span style="color:#66d9ef">=</span> entriesPerPartition<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#a6e22e">TopicPartitionOperationKey</span><span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">)).</span>toSeq  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// try to complete the request immediately, otherwise put it into the purgatory  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// this is because while the delayed produce operation is being created, new    // requests may arrive and hence make this operation completable.    delayedProducePurgatory.tryCompleteElseWatch(delayedProduce, producerRequestKeys)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// we can respond immediately  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> produceResponseStatus <span style="color:#66d9ef">=</span> initialProduceStatus<span style="color:#f92672">.</span>map <span style="color:#f92672">{</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>k<span style="color:#f92672">,</span> status<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> k <span style="color:#f92672">-&gt;</span> status<span style="color:#f92672">.</span>responseStatus <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>    responseCallback<span style="color:#f92672">(</span>produceResponseStatus<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="read">read</h3>
<p>读取日志信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Read a message set from this segment that contains startOffset. The message set will include * no more than maxSize bytes and will end before maxOffset if a maxOffset is specified. * * This method is thread-safe. * * @param startOffset 需要读取的位移开始位置  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param maxSize 读取的最大字节数  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param maxPositionOpt 能读取到的最大文件位置  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param minOneMessage 是否允许消息体过大时，返回的第一条消息size &gt; maxSize  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * * @return The fetched data and the base offset metadata of the message batch that contains startOffset,  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *         or null if the startOffset is larger than the largest offset in this log */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> FetchDataInfo <span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">long</span> startOffset, <span style="color:#66d9ef">int</span> maxSize, Optional<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> maxPositionOpt, <span style="color:#66d9ef">boolean</span> minOneMessage) <span style="color:#66d9ef">throws</span> IOException {  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (maxSize <span style="color:#f92672">&lt;</span> 0)  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException(<span style="color:#e6db74">&#34;Invalid max size &#34;</span> <span style="color:#f92672">+</span> maxSize <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; for log read from segment &#34;</span> <span style="color:#f92672">+</span> log);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1. 调用translateOffset定位到读取的起始文件位置  </span>
</span></span><span style="display:flex;"><span>    LogOffsetPosition startOffsetAndSize <span style="color:#f92672">=</span> translateOffset(startOffset);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if the start position is already off the end of the log, return null  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (startOffsetAndSize <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> startPosition <span style="color:#f92672">=</span> startOffsetAndSize.<span style="color:#a6e22e">position</span>;  
</span></span><span style="display:flex;"><span>    LogOffsetMetadata offsetMetadata <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LogOffsetMetadata(startOffsetAndSize.<span style="color:#a6e22e">offset</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseOffset</span>, startPosition);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1.2 判断消息最大读取长度  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> adjustedMaxSize <span style="color:#f92672">=</span> maxSize;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (minOneMessage)  
</span></span><span style="display:flex;"><span>        adjustedMaxSize <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">max</span>(maxSize, startOffsetAndSize.<span style="color:#a6e22e">size</span>);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return empty records in the fetch-data-info when:  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. adjustedMaxSize is 0 (or)    // 2. maxPosition to read is unavailable    if (adjustedMaxSize == 0 || !maxPositionOpt.isPresent())  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> FetchDataInfo(offsetMetadata, MemoryRecords.<span style="color:#a6e22e">EMPTY</span>);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// calculate the length of the message set to read based on whether or not they gave us a maxOffset  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> fetchSize <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">min</span>((<span style="color:#66d9ef">int</span>) (maxPositionOpt.<span style="color:#a6e22e">get</span>() <span style="color:#f92672">-</span> startPosition), adjustedMaxSize);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. 调用log.slice读取数据  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> FetchDataInfo(offsetMetadata, log.<span style="color:#a6e22e">slice</span>(startPosition, fetchSize),  
</span></span><span style="display:flex;"><span>        adjustedMaxSize <span style="color:#f92672">&lt;</span> startOffsetAndSize.<span style="color:#a6e22e">size</span>, Optional.<span style="color:#a6e22e">empty</span>());  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="日志读取">日志读取</h1>
<p>日志Fetch动作由ReplicaManager中fetchMessages()方法来实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> fetchMessages<span style="color:#f92672">(</span>params<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">FetchParams</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  fetchInfos<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">TopicIdPartition</span>, <span style="color:#66d9ef">PartitionData</span><span style="color:#f92672">)],</span>  
</span></span><span style="display:flex;"><span>                  quota<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ReplicaQuota</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>                  responseCallback<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">TopicIdPartition</span>, <span style="color:#66d9ef">FetchPartitionData</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Unit</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1.1 调用readFromLog方法，获取消息  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// check if this fetch request can be satisfied right away  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> logReadResults <span style="color:#66d9ef">=</span> readFromLog<span style="color:#f92672">(</span>params<span style="color:#f92672">,</span> fetchInfos<span style="color:#f92672">,</span> quota<span style="color:#f92672">,</span> readFromPurgatory <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> bytesReadable<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> errorReadingData <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// The 1st topic-partition that has to be read from remote storage  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> remoteFetchInfo<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Optional</span><span style="color:#f92672">[</span><span style="color:#66d9ef">RemoteStorageFetchInfo</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Optional</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> hasDivergingEpoch <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> hasPreferredReadReplica <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> logReadResultMap <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> mutable<span style="color:#f92672">.</span><span style="color:#a6e22e">HashMap</span><span style="color:#f92672">[</span><span style="color:#66d9ef">TopicIdPartition</span>, <span style="color:#66d9ef">LogReadResult</span><span style="color:#f92672">]</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//2.1 更新统计指标  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  logReadResults<span style="color:#f92672">.</span>foreach <span style="color:#f92672">{</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>topicIdPartition<span style="color:#f92672">,</span> logReadResult<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>    brokerTopicStats<span style="color:#f92672">.</span>topicStats<span style="color:#f92672">(</span>topicIdPartition<span style="color:#f92672">.</span>topicPartition<span style="color:#f92672">.</span>topic<span style="color:#f92672">).</span>totalFetchRequestRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>    brokerTopicStats<span style="color:#f92672">.</span>allTopicsStats<span style="color:#f92672">.</span>totalFetchRequestRate<span style="color:#f92672">.</span>mark<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logReadResult<span style="color:#f92672">.</span>error <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Errors</span><span style="color:#f92672">.</span><span style="color:#a6e22e">NONE</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      errorReadingData <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>remoteFetchInfo<span style="color:#f92672">.</span>isPresent <span style="color:#f92672">&amp;&amp;</span> logReadResult<span style="color:#f92672">.</span>info<span style="color:#f92672">.</span>delayedRemoteStorageFetch<span style="color:#f92672">.</span>isPresent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      remoteFetchInfo <span style="color:#66d9ef">=</span> logReadResult<span style="color:#f92672">.</span>info<span style="color:#f92672">.</span>delayedRemoteStorageFetch  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logReadResult<span style="color:#f92672">.</span>divergingEpoch<span style="color:#f92672">.</span>nonEmpty<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      hasDivergingEpoch <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logReadResult<span style="color:#f92672">.</span>preferredReadReplica<span style="color:#f92672">.</span>nonEmpty<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      hasPreferredReadReplica <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">true</span>  
</span></span><span style="display:flex;"><span>    bytesReadable <span style="color:#66d9ef">=</span> bytesReadable <span style="color:#f92672">+</span> logReadResult<span style="color:#f92672">.</span>info<span style="color:#f92672">.</span>records<span style="color:#f92672">.</span>sizeInBytes  
</span></span><span style="display:flex;"><span>    logReadResultMap<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span>topicIdPartition<span style="color:#f92672">,</span> logReadResult<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//不需要远程获取，或者满足任一条件  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Respond immediately if no remote fetches are required and any of the below conditions is true  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//                        1) fetch request does not want to wait  //                        2) fetch request does not require any data  //                        3) has enough data to respond  //                        4) some error happens while reading data  //                        5) we found a diverging epoch  //                        6) has a preferred read replica  if (!remoteFetchInfo.isPresent &amp;&amp; (params.maxWaitMs &lt;= 0 || fetchInfos.isEmpty || bytesReadable &gt;= params.minBytes || errorReadingData ||  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hasDivergingEpoch <span style="color:#f92672">||</span> hasPreferredReadReplica<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> fetchPartitionData <span style="color:#66d9ef">=</span> logReadResults<span style="color:#f92672">.</span>map <span style="color:#f92672">{</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>tp<span style="color:#f92672">,</span> result<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> isReassignmentFetch <span style="color:#66d9ef">=</span> params<span style="color:#f92672">.</span>isFromFollower <span style="color:#f92672">&amp;&amp;</span> isAddingReplica<span style="color:#f92672">(</span>tp<span style="color:#f92672">.</span>topicPartition<span style="color:#f92672">,</span> params<span style="color:#f92672">.</span>replicaId<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      tp <span style="color:#f92672">-&gt;</span> result<span style="color:#f92672">.</span>toFetchPartitionData<span style="color:#f92672">(</span>isReassignmentFetch<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>    responseCallback<span style="color:#f92672">(</span>fetchPartitionData<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//构建返回结果  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// construct the fetch results from the read results  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> fetchPartitionStatus <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> mutable<span style="color:#f92672">.</span><span style="color:#a6e22e">ArrayBuffer</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">TopicIdPartition</span>, <span style="color:#66d9ef">FetchPartitionStatus</span><span style="color:#f92672">)]</span>  
</span></span><span style="display:flex;"><span>    fetchInfos<span style="color:#f92672">.</span>foreach <span style="color:#f92672">{</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>topicIdPartition<span style="color:#f92672">,</span> partitionData<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>  
</span></span><span style="display:flex;"><span>      logReadResultMap<span style="color:#f92672">.</span>get<span style="color:#f92672">(</span>topicIdPartition<span style="color:#f92672">).</span>foreach<span style="color:#f92672">(</span>logReadResult <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> logOffsetMetadata <span style="color:#66d9ef">=</span> logReadResult<span style="color:#f92672">.</span>info<span style="color:#f92672">.</span>fetchOffsetMetadata  
</span></span><span style="display:flex;"><span>        fetchPartitionStatus <span style="color:#f92672">+=</span> <span style="color:#f92672">(</span>topicIdPartition <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">FetchPartitionStatus</span><span style="color:#f92672">(</span>logOffsetMetadata<span style="color:#f92672">,</span> partitionData<span style="color:#f92672">))</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">})</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//执行远程fetch  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>remoteFetchInfo<span style="color:#f92672">.</span>isPresent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> maybeLogReadResultWithError <span style="color:#66d9ef">=</span> processRemoteFetch<span style="color:#f92672">(</span>remoteFetchInfo<span style="color:#f92672">.</span>get<span style="color:#f92672">(),</span> params<span style="color:#f92672">,</span> responseCallback<span style="color:#f92672">,</span> logReadResults<span style="color:#f92672">,</span> fetchPartitionStatus<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>maybeLogReadResultWithError<span style="color:#f92672">.</span>isDefined<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If there is an error in scheduling the remote fetch task, return what we currently have  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// (the data read from local log segment for the other topic-partitions) and an error for the topic-partition        // that we couldn&#39;t read from remote storage        val partitionToFetchPartitionData = buildPartitionToFetchPartitionData(logReadResults, remoteFetchInfo.get().topicPartition, maybeLogReadResultWithError.get)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        responseCallback<span style="color:#f92672">(</span>partitionToFetchPartitionData<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// If there is not enough data to respond and there is no remote data, we will let the fetch request  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// wait for new data.      val delayedFetch = new DelayedFetch(  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        params <span style="color:#66d9ef">=</span> params<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        fetchPartitionStatus <span style="color:#66d9ef">=</span> fetchPartitionStatus<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        replicaManager <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        quota <span style="color:#66d9ef">=</span> quota<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        responseCallback <span style="color:#66d9ef">=</span> responseCallback  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// create a list of (topic, partition) pairs to use as keys for this delayed fetch operation  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">val</span> delayedFetchKeys <span style="color:#66d9ef">=</span> fetchPartitionStatus<span style="color:#f92672">.</span>map <span style="color:#f92672">{</span> <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>tp<span style="color:#f92672">,</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">TopicPartitionOperationKey</span><span style="color:#f92672">(</span>tp<span style="color:#f92672">)</span> <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// try to complete the request immediately, otherwise put it into the purgatory;  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// this is because while the delayed fetch operation is being created, new requests      // may arrive and hence make this operation completable.      delayedFetchPurgatory.tryCompleteElseWatch(delayedFetch, delayedFetchKeys)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>s
</span></span></code></pre></div><p>readFromLog()方法中通过partition读取消息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#75715e">//调用partition的fetchRecords读取消息  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Try the read first, this tells us whether we need all of adjustedFetchSize for this partition  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> readInfo<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogReadInfo</span> <span style="color:#f92672">=</span> partition<span style="color:#f92672">.</span>fetchRecords<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>  fetchParams <span style="color:#66d9ef">=</span> params<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  fetchPartitionData <span style="color:#66d9ef">=</span> fetchInfo<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  fetchTimeMs <span style="color:#66d9ef">=</span> fetchTimeMs<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  maxBytes <span style="color:#66d9ef">=</span> adjustedMaxBytes<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  minOneMessage <span style="color:#66d9ef">=</span> minOneMessage<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  updateFetchState <span style="color:#66d9ef">=</span> <span style="color:#f92672">!</span>readFromPurgatory<span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> fetchRecords<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>  fetchParams<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">FetchParams</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  fetchPartitionData<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">FetchRequest.PartitionData</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  fetchTimeMs<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  maxBytes<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  minOneMessage<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>  updateFetchState<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogReadInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//定义  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">def</span> readFromLocalLog<span style="color:#f92672">(</span>log<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">UnifiedLog</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogReadInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    readRecords<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>      log<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>      fetchPartitionData<span style="color:#f92672">.</span>lastFetchedEpoch<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>      fetchPartitionData<span style="color:#f92672">.</span>fetchOffset<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>      fetchPartitionData<span style="color:#f92672">.</span>currentLeaderEpoch<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>      maxBytes<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>      fetchParams<span style="color:#f92672">.</span>isolation<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>      minOneMessage  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//检查请求是否来自partition的follower  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fetchParams<span style="color:#f92672">.</span>isFromFollower<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//需要检查是否来自有效的follower  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Check that the request is from a valid replica before doing the read    val (replica, logReadInfo) = inReadLock(leaderIsrUpdateLock) {  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">val</span> localLog <span style="color:#66d9ef">=</span> localLogWithEpochOrThrow<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>        fetchPartitionData<span style="color:#f92672">.</span>currentLeaderEpoch<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        fetchParams<span style="color:#f92672">.</span>fetchOnlyLeader  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> replica <span style="color:#66d9ef">=</span> followerReplicaOrThrow<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>        fetchParams<span style="color:#f92672">.</span>replicaId<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        fetchPartitionData  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> logReadInfo <span style="color:#66d9ef">=</span> readFromLocalLog<span style="color:#f92672">(</span>localLog<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span>replica<span style="color:#f92672">,</span> logReadInfo<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>updateFetchState <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>logReadInfo<span style="color:#f92672">.</span>divergingEpoch<span style="color:#f92672">.</span>isPresent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      updateFollowerFetchState<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>        replica<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        followerFetchOffsetMetadata <span style="color:#66d9ef">=</span> logReadInfo<span style="color:#f92672">.</span>fetchedData<span style="color:#f92672">.</span>fetchOffsetMetadata<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        followerStartOffset <span style="color:#66d9ef">=</span> fetchPartitionData<span style="color:#f92672">.</span>logStartOffset<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        followerFetchTimeMs <span style="color:#66d9ef">=</span> fetchTimeMs<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        leaderEndOffset <span style="color:#66d9ef">=</span> logReadInfo<span style="color:#f92672">.</span>logEndOffset<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        fetchParams<span style="color:#f92672">.</span>replicaEpoch  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    logReadInfo  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    inReadLock<span style="color:#f92672">(</span>leaderIsrUpdateLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> localLog <span style="color:#66d9ef">=</span> localLogWithEpochOrThrow<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>        fetchPartitionData<span style="color:#f92672">.</span>currentLeaderEpoch<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>        fetchParams<span style="color:#f92672">.</span>fetchOnlyLeader  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      readFromLocalLog<span style="color:#f92672">(</span>localLog<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>kafka.log.UnifiedLog#read：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> read<span style="color:#f92672">(</span>startOffset<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>         maxLength<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>         isolation<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">FetchIsolation</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>         minOneMessage<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">FetchDataInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  checkLogStartOffset<span style="color:#f92672">(</span>startOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> maxOffsetMetadata <span style="color:#66d9ef">=</span> isolation <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">FetchIsolation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">LOG_END</span> <span style="color:#66d9ef">=&gt;</span> localLog<span style="color:#f92672">.</span>logEndOffsetMetadata  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">FetchIsolation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">HIGH_WATERMARK</span> <span style="color:#66d9ef">=&gt;</span> fetchHighWatermarkMetadata  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">FetchIsolation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TXN_COMMITTED</span> <span style="color:#66d9ef">=&gt;</span> fetchLastStableOffsetMetadata  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  localLog<span style="color:#f92672">.</span>read<span style="color:#f92672">(</span>startOffset<span style="color:#f92672">,</span> maxLength<span style="color:#f92672">,</span> minOneMessage<span style="color:#f92672">,</span> maxOffsetMetadata<span style="color:#f92672">,</span> isolation <span style="color:#f92672">==</span> <span style="color:#a6e22e">FetchIsolation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TXN_COMMITTED</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>kafka.log.LocalLog#read：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> read<span style="color:#f92672">(</span>startOffset<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>         maxLength<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>         minOneMessage<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>         maxOffsetMetadata<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogOffsetMetadata</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>         includeAbortedTxns<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">FetchDataInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  maybeHandleIOException<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Exception while reading from </span><span style="color:#e6db74">$topicPartition</span><span style="color:#e6db74"> in dir </span><span style="color:#e6db74">${</span>dir<span style="color:#f92672">.</span>getParent<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>    trace<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Reading maximum </span><span style="color:#e6db74">$maxLength</span><span style="color:#e6db74"> bytes at offset </span><span style="color:#e6db74">$startOffset</span><span style="color:#e6db74"> from log with &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">s&#34;total length </span><span style="color:#e6db74">${</span>segments<span style="color:#f92672">.</span>sizeInBytes<span style="color:#e6db74">}</span><span style="color:#e6db74"> bytes&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1.1 选择offset所在的segment  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> endOffsetMetadata <span style="color:#66d9ef">=</span> nextOffsetMetadata  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> endOffset <span style="color:#66d9ef">=</span> endOffsetMetadata<span style="color:#f92672">.</span>messageOffset  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> segmentOpt <span style="color:#66d9ef">=</span> segments<span style="color:#f92672">.</span>floorSegment<span style="color:#f92672">(</span>startOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return error on attempt to read beyond the log end offset  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>startOffset <span style="color:#f92672">&gt;</span> endOffset <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>segmentOpt<span style="color:#f92672">.</span>isPresent<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OffsetOutOfRangeException</span><span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Received request for offset </span><span style="color:#e6db74">$startOffset</span><span style="color:#e6db74"> for partition </span><span style="color:#e6db74">$topicPartition</span><span style="color:#e6db74">, &#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">s&#34;but we only have log segments upto </span><span style="color:#e6db74">$endOffset</span><span style="color:#e6db74">.&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>startOffset <span style="color:#f92672">==</span> maxOffsetMetadata<span style="color:#f92672">.</span>messageOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      emptyFetchDataInfo<span style="color:#f92672">(</span>maxOffsetMetadata<span style="color:#f92672">,</span> includeAbortedTxns<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>startOffset <span style="color:#f92672">&gt;</span> maxOffsetMetadata<span style="color:#f92672">.</span>messageOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      emptyFetchDataInfo<span style="color:#f92672">(</span>convertToOffsetMetadataOrThrow<span style="color:#f92672">(</span>startOffset<span style="color:#f92672">),</span> includeAbortedTxns<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Do the read on the segment with a base offset less than the target offset  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// but if that segment doesn&#39;t contain any messages with an offset greater than that      // continue to read from successive segments until we get some messages or we reach the end of the log      var fetchDataInfo: FetchDataInfo = null  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>fetchDataInfo <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> segmentOpt<span style="color:#f92672">.</span>isPresent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> segment <span style="color:#66d9ef">=</span> segmentOpt<span style="color:#f92672">.</span>get  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> baseOffset <span style="color:#66d9ef">=</span> segment<span style="color:#f92672">.</span>baseOffset  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1. If `maxOffsetMetadata#segmentBaseOffset &lt; segment#baseOffset`, then return maxPosition as empty.  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2. Use the max-offset position if it is on this segment; otherwise, the segment size is the limit.        // 3. When maxOffsetMetadata is message-offset-only, then we don&#39;t know the relativePositionInSegment so        //    return maxPosition as empty to avoid reading beyond the max-offset        val maxPositionOpt: Optional[java.lang.Long] =  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>segment<span style="color:#f92672">.</span>baseOffset <span style="color:#f92672">&lt;</span> maxOffsetMetadata<span style="color:#f92672">.</span>segmentBaseOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Optional</span><span style="color:#f92672">.</span>of<span style="color:#f92672">(</span>segment<span style="color:#f92672">.</span>size<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>segment<span style="color:#f92672">.</span>baseOffset <span style="color:#f92672">==</span> maxOffsetMetadata<span style="color:#f92672">.</span>segmentBaseOffset <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>maxOffsetMetadata<span style="color:#f92672">.</span>messageOffsetOnly<span style="color:#f92672">())</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Optional</span><span style="color:#f92672">.</span>of<span style="color:#f92672">(</span>maxOffsetMetadata<span style="color:#f92672">.</span>relativePositionInSegment<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Optional</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        fetchDataInfo <span style="color:#66d9ef">=</span> segment<span style="color:#f92672">.</span>read<span style="color:#f92672">(</span>startOffset<span style="color:#f92672">,</span> maxLength<span style="color:#f92672">,</span> maxPositionOpt<span style="color:#f92672">,</span> minOneMessage<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fetchDataInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>includeAbortedTxns<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>            fetchDataInfo <span style="color:#66d9ef">=</span> addAbortedTransactions<span style="color:#f92672">(</span>startOffset<span style="color:#f92672">,</span> segment<span style="color:#f92672">,</span> fetchDataInfo<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> segmentOpt <span style="color:#66d9ef">=</span> segments<span style="color:#f92672">.</span>higherSegment<span style="color:#f92672">(</span>baseOffset<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fetchDataInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> fetchDataInfo  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// okay we are beyond the end of the last segment with no data fetched although the start offset is in range,  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// this can happen when all messages with offset larger than start offsets have been deleted.        // In this case, we will return the empty set with log end offset metadata        new FetchDataInfo(nextOffsetMetadata, MemoryRecords.EMPTY)  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>通过LogSegment读取指定位移的消息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> FetchDataInfo <span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">long</span> startOffset, <span style="color:#66d9ef">int</span> maxSize, Optional<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> maxPositionOpt, <span style="color:#66d9ef">boolean</span> minOneMessage) <span style="color:#66d9ef">throws</span> IOException {  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (maxSize <span style="color:#f92672">&lt;</span> 0)  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException(<span style="color:#e6db74">&#34;Invalid max size &#34;</span> <span style="color:#f92672">+</span> maxSize <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; for log read from segment &#34;</span> <span style="color:#f92672">+</span> log);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1.1 将startOffset转换为物理文件位置  </span>
</span></span><span style="display:flex;"><span>    LogOffsetPosition startOffsetAndSize <span style="color:#f92672">=</span> translateOffset(startOffset);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if the start position is already off the end of the log, return null  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (startOffsetAndSize <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> startPosition <span style="color:#f92672">=</span> startOffsetAndSize.<span style="color:#a6e22e">position</span>;  
</span></span><span style="display:flex;"><span>    LogOffsetMetadata offsetMetadata <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LogOffsetMetadata(startOffset, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseOffset</span>, startPosition);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> adjustedMaxSize <span style="color:#f92672">=</span> maxSize;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (minOneMessage)  
</span></span><span style="display:flex;"><span>        adjustedMaxSize <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">max</span>(maxSize, startOffsetAndSize.<span style="color:#a6e22e">size</span>);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return empty records in the fetch-data-info when:  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. adjustedMaxSize is 0 (or)    // 2. maxPosition to read is unavailable    if (adjustedMaxSize == 0 || !maxPositionOpt.isPresent())  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> FetchDataInfo(offsetMetadata, MemoryRecords.<span style="color:#a6e22e">EMPTY</span>);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// calculate the length of the message set to read based on whether or not they gave us a maxOffset  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> fetchSize <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">min</span>((<span style="color:#66d9ef">int</span>) (maxPositionOpt.<span style="color:#a6e22e">get</span>() <span style="color:#f92672">-</span> startPosition), adjustedMaxSize);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//调用slice获取消息  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> FetchDataInfo(offsetMetadata, log.<span style="color:#a6e22e">slice</span>(startPosition, fetchSize),  
</span></span><span style="display:flex;"><span>        adjustedMaxSize <span style="color:#f92672">&lt;</span> startOffsetAndSize.<span style="color:#a6e22e">size</span>, Optional.<span style="color:#a6e22e">empty</span>());  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里并没有从本地文件中读取实际的消息，这是lazy-load方式，实际读取逻辑在：org.apache.kafka.common.record.FileLogInputStream.FileChannelRecordBatch#loadBatchWithSize</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> RecordBatch <span style="color:#a6e22e">loadBatchWithSize</span>(<span style="color:#66d9ef">int</span> size, String description) {  
</span></span><span style="display:flex;"><span>    FileChannel channel <span style="color:#f92672">=</span> fileRecords.<span style="color:#a6e22e">channel</span>();  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {  
</span></span><span style="display:flex;"><span>        ByteBuffer buffer <span style="color:#f92672">=</span> ByteBuffer.<span style="color:#a6e22e">allocate</span>(size);  
</span></span><span style="display:flex;"><span>        Utils.<span style="color:#a6e22e">readFullyOrFail</span>(channel, buffer, position, description);  
</span></span><span style="display:flex;"><span>        buffer.<span style="color:#a6e22e">rewind</span>();  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> toMemoryRecordBatch(buffer);  
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (IOException e) {  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> KafkaException(<span style="color:#e6db74">&#34;Failed to load record batch at position &#34;</span> <span style="color:#f92672">+</span> position <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; from &#34;</span> <span style="color:#f92672">+</span> fileRecords, e);  
</span></span><span style="display:flex;"><span>    }  
</span></span><span style="display:flex;"><span>}s
</span></span></code></pre></div><h1 id="索引重建">索引重建</h1>
<p>broker启动加载所有segment时，若Index文件损坏或缺失，会调用索引重建逻辑：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> segment<span style="color:#f92672">.</span>sanityCheck<span style="color:#f92672">(</span>timeIndexFileNewlyCreated<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">_:</span> <span style="color:#66d9ef">NoSuchFileException</span> <span style="color:#f92672">=&gt;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hadCleanShutdown <span style="color:#f92672">||</span> segment<span style="color:#f92672">.</span>baseOffset <span style="color:#f92672">&lt;</span> recoveryPointCheckpoint<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>      error<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Could not find offset index file corresponding to log file&#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">s&#34; </span><span style="color:#e6db74">${</span>segment<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>file<span style="color:#f92672">.</span>getAbsolutePath<span style="color:#e6db74">}</span><span style="color:#e6db74">, recovering segment and rebuilding index files...&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    recoverSegment<span style="color:#f92672">(</span>segment<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">case</span> e<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">CorruptIndexException</span> <span style="color:#f92672">=&gt;</span>  
</span></span><span style="display:flex;"><span>    warn<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;Found a corrupted index file corresponding to log file&#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">s&#34; </span><span style="color:#e6db74">${</span>segment<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>file<span style="color:#f92672">.</span>getAbsolutePath<span style="color:#e6db74">}</span><span style="color:#e6db74"> due to </span><span style="color:#e6db74">${</span>e<span style="color:#f92672">.</span>getMessage<span style="color:#e6db74">}</span><span style="color:#e6db74">}, recovering segment and&#34;</span> <span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34; rebuilding index files...&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>    recoverSegment<span style="color:#f92672">(</span>segment<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> recoverSegment<span style="color:#f92672">(</span>segment<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LogSegment</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> producerStateManager <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ProducerStateManager</span><span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>    topicPartition<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    dir<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span>producerStateManager<span style="color:#f92672">.</span>maxTransactionTimeoutMs<span style="color:#f92672">(),</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span>producerStateManager<span style="color:#f92672">.</span>producerStateManagerConfig<span style="color:#f92672">(),</span>  
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">UnifiedLog</span><span style="color:#f92672">.</span>rebuildProducerState<span style="color:#f92672">(</span>  
</span></span><span style="display:flex;"><span>    producerStateManager<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    segments<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    logStartOffsetCheckpoint<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    segment<span style="color:#f92672">.</span>baseOffset<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>recordVersion<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    reloadFromCleanShutdown <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>  
</span></span><span style="display:flex;"><span>    logIdent<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> bytesTruncated <span style="color:#66d9ef">=</span> segment<span style="color:#f92672">.</span>recover<span style="color:#f92672">(</span>producerStateManager<span style="color:#f92672">,</span> leaderEpochCache<span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// once we have recovered the segment&#39;s data, take a snapshot to ensure that we won&#39;t  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// need to reload the same segment again while recovering another segment.  producerStateManager.takeSnapshot()  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  bytesTruncated  
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Run recovery on the given segment. This will rebuild the index from the log file and lop off any invalid bytes * from the end of the log and index. * * This method is not thread-safe. * * @param producerStateManager producer状态管理，用于恢复事务索引  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param leaderEpochCache 用于更新leader选举周期  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return 从log中截断的字节数  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @throws LogSegmentOffsetOverflowException if the log segment contains an offset that causes the index offset to overflow  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">recover</span>(ProducerStateManager producerStateManager, Optional<span style="color:#f92672">&lt;</span>LeaderEpochFileCache<span style="color:#f92672">&gt;</span> leaderEpochCache) <span style="color:#66d9ef">throws</span> IOException {  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. 清空所有的索引文件  </span>
</span></span><span style="display:flex;"><span>    offsetIndex().<span style="color:#a6e22e">reset</span>();  
</span></span><span style="display:flex;"><span>    timeIndex().<span style="color:#a6e22e">reset</span>();  
</span></span><span style="display:flex;"><span>    txnIndex.<span style="color:#a6e22e">reset</span>();  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> validBytes <span style="color:#f92672">=</span> 0;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> lastIndexEntry <span style="color:#f92672">=</span> 0;  
</span></span><span style="display:flex;"><span>    maxTimestampAndOffsetSoFar <span style="color:#f92672">=</span> TimestampOffset.<span style="color:#a6e22e">UNKNOWN</span>;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2. 遍历log的RecordBatch  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (RecordBatch batch : log.<span style="color:#a6e22e">batches</span>()) {  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//2.1 校验batch是否合法  </span>
</span></span><span style="display:flex;"><span>            batch.<span style="color:#a6e22e">ensureValid</span>();  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//2.2 保证最后一条消息offset在范围内  </span>
</span></span><span style="display:flex;"><span>            ensureOffsetInRange(batch.<span style="color:#a6e22e">lastOffset</span>());  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//2.3 校验batch最大时间戳是否大于segment最大时间戳  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (batch.<span style="color:#a6e22e">maxTimestamp</span>() <span style="color:#f92672">&gt;</span> maxTimestampSoFar()) {  
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//2.3.1 更新maxTimestampAndOffsetSoFar  </span>
</span></span><span style="display:flex;"><span>                maxTimestampAndOffsetSoFar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TimestampOffset(batch.<span style="color:#a6e22e">maxTimestamp</span>(), batch.<span style="color:#a6e22e">lastOffset</span>());  
</span></span><span style="display:flex;"><span>            }  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 3. 构建index  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (validBytes <span style="color:#f92672">-</span> lastIndexEntry <span style="color:#f92672">&gt;</span> indexIntervalBytes) {  
</span></span><span style="display:flex;"><span>                offsetIndex().<span style="color:#a6e22e">append</span>(batch.<span style="color:#a6e22e">lastOffset</span>(), validBytes);  
</span></span><span style="display:flex;"><span>                timeIndex().<span style="color:#a6e22e">maybeAppend</span>(maxTimestampSoFar(), shallowOffsetOfMaxTimestampSoFar());  
</span></span><span style="display:flex;"><span>                lastIndexEntry <span style="color:#f92672">=</span> validBytes;  
</span></span><span style="display:flex;"><span>            }  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//3.1 更新validBytes  </span>
</span></span><span style="display:flex;"><span>            validBytes <span style="color:#f92672">+=</span> batch.<span style="color:#a6e22e">sizeInBytes</span>();  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//4. 更新leader选举周期  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (batch.<span style="color:#a6e22e">magic</span>() <span style="color:#f92672">&gt;=</span> RecordBatch.<span style="color:#a6e22e">MAGIC_VALUE_V2</span>) {  
</span></span><span style="display:flex;"><span>                leaderEpochCache.<span style="color:#a6e22e">ifPresent</span>(cache <span style="color:#f92672">-&gt;</span> {  
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 4.1 获取batch的选举周期，如果 partitionLeaderEpoch &gt; cache latestEpoch，则更新cache  </span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (batch.<span style="color:#a6e22e">partitionLeaderEpoch</span>() <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span>  
</span></span><span style="display:flex;"><span>                            (<span style="color:#f92672">!</span>cache.<span style="color:#a6e22e">latestEpoch</span>().<span style="color:#a6e22e">isPresent</span>() <span style="color:#f92672">||</span> batch.<span style="color:#a6e22e">partitionLeaderEpoch</span>() <span style="color:#f92672">&gt;</span> cache.<span style="color:#a6e22e">latestEpoch</span>().<span style="color:#a6e22e">getAsInt</span>()))  
</span></span><span style="display:flex;"><span>                        cache.<span style="color:#a6e22e">assign</span>(batch.<span style="color:#a6e22e">partitionLeaderEpoch</span>(), batch.<span style="color:#a6e22e">baseOffset</span>());  
</span></span><span style="display:flex;"><span>                });  
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//4.2 更新producer状态  </span>
</span></span><span style="display:flex;"><span>                updateProducerState(producerStateManager, batch);  
</span></span><span style="display:flex;"><span>            }  
</span></span><span style="display:flex;"><span>        }  
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (CorruptRecordException <span style="color:#f92672">|</span> InvalidRecordException e) {  
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Found invalid messages in log segment {} at byte offset {}.&#34;</span>, log.<span style="color:#a6e22e">file</span>().<span style="color:#a6e22e">getAbsolutePath</span>(),  
</span></span><span style="display:flex;"><span>            validBytes, e);  
</span></span><span style="display:flex;"><span>    }  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> truncated <span style="color:#f92672">=</span> log.<span style="color:#a6e22e">sizeInBytes</span>() <span style="color:#f92672">-</span> validBytes;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (truncated <span style="color:#f92672">&gt;</span> 0)  
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;Truncated {} invalid bytes at the end of segment {} during recovery&#34;</span>, truncated, log.<span style="color:#a6e22e">file</span>().<span style="color:#a6e22e">getAbsolutePath</span>());  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//5. 底层调用FileChannel的truncate方法截断文件，用于清理末尾的无效字节</span>
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">truncateTo</span>(validBytes);  
</span></span><span style="display:flex;"><span>    offsetIndex().<span style="color:#a6e22e">trimToValidSize</span>();  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// A normally closed segment always appends the biggest timestamp ever seen into log segment, we do this as well.  </span>
</span></span><span style="display:flex;"><span>    timeIndex().<span style="color:#a6e22e">maybeAppend</span>(maxTimestampSoFar(), shallowOffsetOfMaxTimestampSoFar(), <span style="color:#66d9ef">true</span>); 
</span></span><span style="display:flex;"><span>    timeIndex().<span style="color:#a6e22e">trimToValidSize</span>();  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> truncated;  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
            </div>
          </div>
          <div class="col-xs-12 col-md-3">
            <div class="post-toc">
              <nav id="TableOfContents">
  <ul>
    <li><a href="#intro">Intro</a></li>
    <li><a href="#日志写入">日志写入</a>
      <ul>
        <li><a href="#appendrecords">appendRecords</a></li>
        <li><a href="#appendtolocallog">appendToLocalLog</a></li>
        <li><a href="#maybeadddelayedproduce">maybeAddDelayedProduce</a>
          <ul>
            <li><a href="#read">read</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#日志读取">日志读取</a></li>
    <li><a href="#索引重建">索引重建</a></li>
  </ul>
</nav>
            </div>
          </div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
          </div>
        </div>
        
          <div class="row">
            <div class="col-xs-12">
              
            </div>
          </div>

          



          
          
          <div style="height: 50px;"></div>
          
          <div class="post-comments">
            <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://evl1nker4.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

          </div>
          
        

        <div class="site-footer">
  
  
</div>

      </div>
    </div>
  </article>

  

<script>
  
  
    
    
  
</script>

  

</body>

</html>